name: Publish PowerShell Module

run-name: >
  ${{ github.workflow }}: ${{ github.event_name }} for ${{ github.ref_name }} by @${{ github.actor }}

on:
    push:
        branches:
            - main

jobs:
    publish:
        runs-on: windows-latest

        steps:
        - name: Checkout repository
          uses: actions/checkout@v4

        - name: Azure Login
          uses: azure/login@v2
          with:
            creds: ${{secrets.AZURE_CREDENTIALS}}
            enable-AzPSSession: true 

        - name: Install PSResourceGet
          shell: pwsh
          run: |
            $InstallArgs = @{
                Repository = 'PSGallery'
                Name = 'Microsoft.PowerShell.PSResourceGet'
                AllowPrerelease = $true
            }
            Install-Module @InstallArgs

        - name: Register PSResourceRepository
          shell: pwsh
          run: |
            Register-PSResourceRepository -Name ${{ vars.PS_REPO_NAME }} -Uri ${{ vars.PS_REPO_URL }} -Trusted:$True

        - name: Publish PowerShell Module
          shell: pwsh
          run: |
            Publish-PSResource -Path . -Repository ${{ vars.PS_REPO_NAME }} -Verbose